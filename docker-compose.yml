services:
  # Nginx 反向代理
  nginx:
    image: nginx:1.25.2-alpine
    container_name: nginx_proxy
    ports:
      - "8090:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - fastapi
    environment:
      - TZ=Asia/Shanghai
    networks:
      - app-network

  # 前端React服务
  frontend:
    build:
      context: ./my-app
    image: project-root-frontend:v1.0.0
    restart: always
    environment:
      - TZ=Asia/Shanghai
    networks:
      - app-network

  # 后端FastAPI服务
  fastapi:
    build:
      context: ./fastApiProject
    image: project-root-fastapi:v1.0.0
    restart: always
    ports:
      - "8091:8091"
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DB_TEST_HOST=${DB_TEST_HOST}
      - DB_TEST_PORT=${DB_TEST_PORT}
      - DB_TEST_USER=${DB_TEST_USER}
      - DB_TEST_PASSWORD=${DB_TEST_PASSWORD}
      - DB_TEST_DATABASE=${DB_TEST_DATABASE}
      - DB_PROD_HOST=${DB_PROD_HOST}
      - DB_PROD_PORT=${DB_PROD_PORT}
      - DB_PROD_USER=${DB_PROD_USER}
      - DB_PROD_PASSWORD=${DB_PROD_PASSWORD}
      - DB_PROD_DATABASE=${DB_PROD_DATABASE}
      - BASE_URL_TEST=${BASE_URL_TEST}
      - BASE_URL_PROD=${BASE_URL_PROD}
      - BASE_URL_LOCAL=${BASE_URL_LOCAL}
      - SMS_API_BASE_TEST=${SMS_API_BASE_TEST}
      - SMS_API_BASE_PROD=${SMS_API_BASE_PROD}
      - SMS_AUTH_TOKEN_TEST=${SMS_AUTH_TOKEN_TEST}
      - SMS_AUTH_TOKEN_PROD=${SMS_AUTH_TOKEN_PROD}
      - SMS_ORIGIN_TEST=${SMS_ORIGIN_TEST}
      - SMS_ORIGIN_PROD=${SMS_ORIGIN_PROD}
      - SMS_REFERER_TEST=${SMS_REFERER_TEST}
      - SMS_REFERER_PROD=${SMS_REFERER_PROD}
      - PRESET_MOBILES=${PRESET_MOBILES}
      - CORS_ORIGINS=http://localhost,http://127.0.0.1,http://192.168.1.0/24,http://192.168.20.0/24,http://mac-mini.tail150593.ts.net
      - TZ=Asia/Shanghai
    networks:
      - app-network

networks:
  app-network:
    driver: bridge